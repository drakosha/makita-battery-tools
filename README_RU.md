# Диагностический инструмент для аккумуляторов Makita

Прошивка Arduino Nano для диагностики, чтения и сброса литий-ионных аккумуляторов Makita LXT через кастомный протокол, похожий на OneWire.

## Обзор

Этот инструмент позволяет:
- **Читать информацию об аккумуляторе**: модель, ёмкость, циклы заряда, состояние здоровья
- **Мониторить напряжение ячеек**: индивидуальное напряжение каждой ячейки с расчётом SOC (уровня заряда)
- **Проверять температуру**: датчики температуры ячеек и MOSFET
- **Разблокировать заблокированные аккумуляторы**: сброс кодов ошибок и очистка флагов блокировки в EEPROM
- **Клонировать конфигурацию**: копировать MSG данные с рабочего аккумулятора на неисправный
- **Диагностировать проблемы с зарядкой**: тестировать протокол рукопожатия DC18RC
- **Управлять светодиодами**: включать/выключать индикаторные светодиоды для тестирования

## Благодарности

Основано на исследованиях и коде:
- [open-battery-information](https://github.com/mnh-jansson/open-battery-information) от Martin Jansson
- [m5din-makita](https://github.com/no-body-in-particular/m5din-makita) от no-body-in-particular
- [makita-lxt-protocol](https://codeberg.org/rosvall/makita-lxt-protocol) от rosvall

## Требования к оборудованию

### Компоненты
- Arduino Nano (ATmega328P)
- Резистор 4.7 кОм (подтяжка линии данных)
- Провода для подключения

### Схема подключения

```
Arduino Nano              Аккумулятор Makita
============              ==================
Pin D6 (Data)  ─────────── Data
     │
     ├── 4.7kΩ ── 5V       (подтягивающий резистор)

Pin D8 (Enable) ────────── Enable
GND ────────────────────── GND
```

**Важно**: Линия данных ТРЕБУЕТ подтягивающий резистор 4.7 кОм к 5V для надёжной связи.

### Распиновка разъёма аккумулятора

Вид на аккумулятор спереди (контакты направлены к вам):

```
┌─────────────────────────┐
│  ○   ○   ○   ○   ○   ○  │
│  1   2   3   4   5   6  │
└─────────────────────────┘

Пин 1: V+ (Плюс аккумулятора)
Пин 2: Data
Пин 3: Enable
Пин 4: GND
Пин 5: GND (или NTC на некоторых моделях)
Пин 6: V+ (Плюс аккумулятора)
```

## Установка

### Вариант 1: PlatformIO (Рекомендуется)

```bash
# Клонируйте или скачайте проект
cd MakitaBatterySerial

# Сборка прошивки
pio run

# Загрузка в Arduino Nano
pio run --target upload

# Открыть Serial Monitor (9600 бод)
pio device monitor
```

### Вариант 2: Arduino IDE

1. Откройте `arduino/MakitaBatteryDiagnostic/MakitaBatteryDiagnostic.ino` в Arduino IDE
2. Выберите **Инструменты → Плата → Arduino Nano**
3. Выберите **Инструменты → Процессор → ATmega328P** (или "Old Bootloader" если загрузка не работает)
4. Выберите COM-порт в **Инструменты → Порт**
5. Нажмите **Загрузка**
6. Откройте **Инструменты → Монитор порта** на скорости 9600 бод

Версия для Arduino IDE — это единый файл скетча со всем кодом, включая модифицированную библиотеку OneWire с таймингами Makita.

## Использование

### Команды серийного меню

Подключитесь к Arduino через серийный терминал на скорости **9600 бод**. Доступны следующие команды:

| Клавиша | Команда | Описание |
|---------|---------|----------|
| `1` | Чтение данных | Показать полную информацию об аккумуляторе |
| `2` | Сброс ошибок (быстрый) | Сброс ошибок BMS без записи в EEPROM |
| `3` | Разблокировка | Полная процедура разблокировки с записью в EEPROM |
| `4` | LED ON | Включить индикаторные светодиоды |
| `5` | LED OFF | Выключить индикаторные светодиоды |
| `6` | Отладочный дамп | Показать сырые данные и анализ MSG |
| `7` | Проверка блокировки | Быстрая проверка статуса блокировки |
| `s` | Сохранить MSG | Сохранить текущий MSG в память для сравнения |
| `d` | Сравнить MSG | Показать изменения между сохранённым и текущим MSG |
| `v` | Клонировать MSG | Записать сохранённый MSG в текущий аккумулятор |
| `a` | Расширенный сброс | Подменю с дополнительными опциями |
| `h` | Помощь | Показать меню |

### Меню расширенного сброса (Опция `a`)

| Клавиша | Команда | Описание |
|---------|---------|----------|
| `1` | Заводской сброс | Сброс с использованием "магических" байтов |
| `2` | Сброс рукопожатия | Очистить зависшее состояние рукопожатия с зарядным |
| `3` | Установить счётчик циклов | Вручную установить счётчик циклов заряда |
| `4` | Заблокировать (тест) | Намеренно заблокировать для тестирования |

## Понимание данных аккумулятора

### Пример вывода информации

```
========================================
   MAKITA BATTERY DIAGNOSTIC TOOL
========================================

Model: BL1850B
Type: 18V Li-ion
Capacity: 5000 mAh
Cycles: 127
Health: 92%

Cell Voltages:
  Cell 1: 4.12V (95%)
  Cell 2: 4.11V (94%)
  Cell 3: 4.13V (96%)
  Cell 4: 4.10V (93%)
  Cell 5: 4.11V (94%)
  Pack:   20.57V
  Diff:   0.03V (OK)

Temperatures:
  Cell:   24.5°C
  MOSFET: 26.2°C

Status: OK (Unlocked)
```

### Таблица SOC (State of Charge - уровень заряда)

| Напряжение ячейки | SOC | Напряжение сборки (5S) |
|-------------------|-----|------------------------|
| 4.20V | 100% | 21.0V |
| 4.00V | 80% | 20.0V |
| 3.80V | 60% | 19.0V |
| 3.70V | 50% | 18.5V |
| 3.50V | 30% | 17.5V |
| 3.00V | 0% | 15.0V |

### Коды ошибок

| Код | Значение | Решение |
|-----|----------|---------|
| 0x0 | OK | Аккумулятор исправен |
| 0x1 | Перегрузка | Сбросить опцией 3 |
| 0x5 | Предупреждение | Проверить ячейки, сбросить опцией 3 |
| 0xF | Мёртвый | Возможно требуется замена ячеек |

### Статус блокировки

Аккумулятор может быть заблокирован по причине:
- **Флаг ошибки** в MSG байте 20 (младший нибл)
- **Флаг блокировки** в MSG байте 20 (биты состояния блокировки)
- **Несовпадение контрольной суммы** - BMS обнаружил повреждение данных
- **Флаг переразряда** в MSG байте 24
- **Флаг перегрузки** в MSG байте 25

## Варианты сброса

### Опция 2: Быстрый сброс (без EEPROM)

- Отправляет команды testmode + reset_error несколько раз
- НЕ изменяет EEPROM
- Используйте когда BMS временно завис, но EEPROM в порядке
- Быстро и безопасно для первой попытки

### Опция 3: Полная разблокировка (запись EEPROM)

Трёхфазная агрессивная разблокировка:
1. **Фаза 1**: Стандартные команды сброса (5 циклов)
2. **Фаза 2**: Запись в EEPROM с пересчётом контрольных сумм
3. **Фаза 3**: Расширенное циклирование питания с повторными сбросами

Очищает:
- Код ошибки (нибл 40)
- Флаги блокировки
- Счётчик переразряда
- Флаги перегрузки
- Пересчитывает все контрольные суммы MSG

### Расширенный: Заводской сброс

Применяет известные "магические" байтовые паттерны, используемые при заводском программировании. Варианты:
- Минимальный сброс (только очистка ошибки)
- Паттерн 0xC1 (используется в некоторых типах аккумуляторов)
- Паттерн 0x94 (используется в других типах)

### Расширенный: Сброс рукопожатия

Для аккумуляторов, которые разблокированы, но всё равно не заряжаются на Makita DC18RC:
1. Длительное циклирование питания
2. Повторная последовательность testmode/reset
3. Очистка EEPROM с исправлением контрольных сумм
4. Финальное циклирование питания

## Клонирование донорского аккумулятора

Если у вас есть рабочий аккумулятор той же модели, можно клонировать его конфигурацию:

1. Подключите **рабочий** аккумулятор
2. Нажмите `s` для сохранения MSG
3. Отключите рабочий аккумулятор
4. Подключите **неисправный** аккумулятор
5. Нажмите `v` для клонирования MSG
6. Подтвердите нажатием `y`

Инструмент выполнит:
- Копирование сохранённого MSG в неисправный аккумулятор
- Очистку кодов ошибок
- Пересчёт контрольных сумм
- Запись в EEPROM

**Внимание**: Клонируйте только между аккумуляторами ОДНОЙ модели!

## Устранение неполадок

### Аккумулятор разблокирован, но не заряжается на Makita DC18RC

DC18RC выполняет больше проверок, чем дешёвые зарядные устройства:

| Проверка | DC18RC | Дешёвое ЗУ |
|----------|--------|------------|
| MSG (ошибка/блокировка) | ✓ | ✓ |
| Датчики температуры | ✓ | ✗ |
| Валидность ответа BMS | ✓ | ✗ |
| Напряжение ячеек через BMS | ✓ | ✗ |
| SMBus рукопожатие | ✓ | ✗ |

**Красно-зелёное мигание** = Не удаётся завершить рукопожатие с BMS

Шаги диагностики:
1. Используйте опцию `6` (Отладочный дамп) для просмотра сырых данных
2. Используйте опцию `s` для сохранения MSG перед попыткой зарядки
3. Попробуйте зарядное Makita
4. Используйте опцию `d` для сравнения MSG и просмотра изменений

**Если зарядка всё ещё не работает**:
1. Проверьте контакты ячеек под платой (могут выглядеть нормально, но быть отсоединены)
2. Проверьте предохранитель BMS
3. Проверьте паяные соединения возле разъёма
4. Попробуйте опцию `a` → `2` (Сброс рукопожатия)

### Нет связи с аккумулятором

- Убедитесь, что подтягивающий резистор 4.7 кОм подключён
- Проверьте соединения проводов
- Убедитесь, что пин Enable подключён
- Попробуйте другой аккумулятор (чтобы исключить полностью мёртвый BMS)

### Некорректные показания

- Проверьте надёжность соединений
- Убедитесь в правильности назначения пинов
- Некоторые типы аккумуляторов (чипы F0513) имеют ограниченную поддержку

## Технические детали

### Протокол Makita OneWire

Makita использует модифицированный протокол, похожий на OneWire, с нестандартными таймингами:

| Параметр | Стандартный 1-Wire | Makita |
|----------|-------------------|--------|
| Reset импульс | 480 мкс | 750 мкс |
| Write 1 | 6/64 мкс | 12/120 мкс |
| Write 0 | 60/10 мкс | 100/30 мкс |
| Read | 6/9 мкс | 10/10 мкс |

### Справочник команд

| Команда | Параметры | Описание |
|---------|-----------|----------|
| `0x33` | - | Чтение ROM (возвращает 8 байт) |
| `0xCC` | - | Skip ROM (адресация всех устройств) |
| `0xD7` | offset, 0x00, count | Чтение блока данных |
| `0xF0` | 0x00 | Команда зарядного (возвращает ROM + MSG) |
| `0xD9` | 0x96, 0xA5 | Вход в тестовый режим |
| `0xDA` | 0x04 | Сброс ошибки |
| `0xDA` | 0x31 | Включение светодиодов |
| `0xDA` | 0x34 | Выключение светодиодов |
| `0x0F` | 0x00 + 32 байта | Запись MSG в буфер |
| `0x55` | 0xA5 | Сохранение буфера в EEPROM |

### Структура MSG (32 байта)

| Байт | Ниблы | Описание |
|------|-------|----------|
| 11 | 22-23 | Код типа аккумулятора |
| 16 | 32-33 | Код ёмкости |
| 20 | 40-41 | Ошибка (мл. нибл), Checksum1 (ст. нибл) |
| 21 | 42-43 | Checksum2 (мл. нибл), Checksum3 (ст. нибл) |
| 24 | 48-49 | Счётчик переразряда |
| 25 | 50-51 | Флаги перегрузки |
| 26-27 | 52-55 | Счётчик циклов (13-бит) |

### Расчёт контрольных сумм

MSG использует три контрольные суммы, покрывающие разные диапазоны байтов:
- Checksum1 (нибл 41): Покрывает ниблы 0-40
- Checksum2 (нибл 42): Покрывает ниблы 0-41
- Checksum3 (нибл 43): Покрывает ниблы 0-42

Формула: `min(сумма_ниблов, 0xFF) & 0x0F`

## Поддерживаемые аккумуляторы

### Серия 18V LXT
- BL1815, BL1815N
- BL1820, BL1820B
- BL1830, BL1830B
- BL1840, BL1840B
- BL1850, BL1850B
- BL1860, BL1860B

### Серия 14.4V
- BL1415, BL1415N
- BL1430, BL1430B
- BL1440
- BL1450

### Серия 40V XGT (Ограниченная поддержка)
- BL4020, BL4025
- BL4040, BL4050

**Примечание**: 40V аккумуляторы используют 10 ячеек и могут иметь различия в протоколе.

### Варианты чипов

| Чип | Возможности | Примечания |
|-----|-------------|------------|
| Стандартный | Полная поддержка | 2 датчика температуры |
| F0513 | Ограниченная | 1 датчик температуры, нет сброса ошибок через команды |

## Структура проекта

```
MakitaBatterySerial/
├── platformio.ini          # Конфигурация PlatformIO
├── README.md               # Документация (английский)
├── README_RU.md            # Документация (русский)
├── CLAUDE.md               # Контекст для AI-ассистента
├── src/                    # Исходники PlatformIO
│   ├── main.cpp            # Главная программа и серийное меню
│   ├── config.h            # Определения пинов и общие данные
│   ├── makita_comm.h/cpp   # Низкоуровневая коммуникация
│   ├── makita_commands.h/cpp # Команды протокола
│   ├── makita_data.h/cpp   # Парсинг данных и вычисления
│   ├── makita_print.h/cpp  # Форматирование вывода
│   └── makita_unlock.h/cpp # Функции сброса и разблокировки
├── lib/
│   └── OneWire/            # Модифицированная библиотека OneWire с таймингами Makita
└── arduino/
    └── MakitaBatteryDiagnostic/
        └── MakitaBatteryDiagnostic.ino  # Версия для Arduino IDE (один файл)
```

## Использование памяти

- Flash: ~25КБ (82%) - Есть место для расширения LCD
- RAM: ~500 байт (24%)

## Планы на будущее

- [ ] Поддержка LCD дисплея (16x2 или OLED)
- [ ] Автономная работа (питание от аккумулятора)
- [ ] Режим сравнения нескольких аккумуляторов
- [ ] Расширенная поддержка 40V аккумуляторов

## Предупреждения по безопасности

- **Не** замыкайте клеммы аккумулятора
- **Не** пытайтесь заряжать ячейки с обратной полярностью
- **Не** используйте повреждённые или вздутые аккумуляторы
- **Всегда** проверяйте подключения перед включением питания
- Литий-ионные аккумуляторы могут быть опасны при неправильном обращении
- Этот инструмент изменяет EEPROM аккумулятора - используйте на свой риск

## Лицензия

MIT License

Copyright (c) 2024

Настоящим предоставляется бесплатное разрешение любому лицу, получившему копию
данного программного обеспечения и сопутствующей документации ("Программное обеспечение"),
использовать Программное обеспечение без ограничений, включая, без ограничений,
права на использование, копирование, изменение, слияние, публикацию, распространение,
сублицензирование и/или продажу копий Программного обеспечения, а также разрешать
лицам, которым предоставляется Программное обеспечение, делать это при соблюдении
следующих условий:

Вышеупомянутое уведомление об авторских правах и данное уведомление о разрешении
должны быть включены во все копии или существенные части Программного обеспечения.

ПРОГРАММНОЕ ОБЕСПЕЧЕНИЕ ПРЕДОСТАВЛЯЕТСЯ "КАК ЕСТЬ", БЕЗ КАКИХ-ЛИБО ГАРАНТИЙ,
ЯВНЫХ ИЛИ ПОДРАЗУМЕВАЕМЫХ, ВКЛЮЧАЯ, НО НЕ ОГРАНИЧИВАЯСЬ, ГАРАНТИЯМИ ТОВАРНОЙ
ПРИГОДНОСТИ, СООТВЕТСТВИЯ ОПРЕДЕЛЁННОЙ ЦЕЛИ И НЕНАРУШЕНИЯ ПРАВ. НИ ПРИ КАКИХ
ОБСТОЯТЕЛЬСТВАХ АВТОРЫ ИЛИ ПРАВООБЛАДАТЕЛИ НЕ НЕСУТ ОТВЕТСТВЕННОСТИ ЗА ЛЮБЫЕ
ПРЕТЕНЗИИ, УБЫТКИ ИЛИ ИНУЮ ОТВЕТСТВЕННОСТЬ, БУДЬ ТО В РАМКАХ ДОГОВОРА, ДЕЛИКТА
ИЛИ ИНЫМ ОБРАЗОМ, ВОЗНИКАЮЩУЮ ИЗ, В СВЯЗИ ИЛИ В РЕЗУЛЬТАТЕ ИСПОЛЬЗОВАНИЯ
ПРОГРАММНОГО ОБЕСПЕЧЕНИЯ ИЛИ ИНЫХ ДЕЙСТВИЙ С ПРОГРАММНЫМ ОБЕСПЕЧЕНИЕМ.
